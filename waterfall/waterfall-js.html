<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>waterfall-js</title>
    <style>
    html, body, div, img {
        margin: 0;
        padding: 0;
    }

    #main {
        position: relative;
    }

    #main .box {
        padding: 10px;
        float: left;
    }

    #main .box .pic {
        width: 200px;
        padding: 10px;
        border: 1px solid #ccc;
        box-shadow: 0 0 5px #ccc;
        border-radius: 5px;
    }

    #main .box .pic img {
        width: 100%;
        height: auto;
    }
    </style>
</head>
<body>
    <div id="main">
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
    </div>

    <script>
    function getByClass(clsName, parentId){
        var returnArr = [];
        if (clsName) {
            var parentObj = document.getElementById(parentId) || document;
            var childs = parentObj.getElementsByTagName("*");
            var reg = new RegExp("(\\s|^)" + clsName + "(\\s|$)");
            for (var i = 0; i < childs.length; i++) {
                if (reg.test(childs[i].className)) {
                    returnArr.push(childs[i]);
                }
            }
        }
        return returnArr;
    }

    function getIndexOfArr(arr, value) {
        if (arr) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == value) {
                    return i;
                }
            }
        }
    }

    function loadWaterfall(mainId, boxClassName) {
        var main = document.getElementById(mainId);
        var items = getByClass(boxClassName, mainId);
        if (items) {
            var itemW = items[0].offsetWidth;
            var pageW = document.documentElement.clientWidth || document.body.clientWidth;
            var colNum = Math.floor(pageW / itemW);
            main.style.cssText = "width: " + itemW * colNum + "px; margin: 0 auto;";
            var colHeightArr = [];

            for (var i = 0; i < items.length; i++) {
                if (i < colNum) {
                    colHeightArr.push(items[i].offsetHeight);
                } else {
                    var minHeight = Math.min.apply(null, colHeightArr);
                    var colIndex = getIndexOfArr(colHeightArr, minHeight);
                    items[i].style.position = "absolute";
                    items[i].style.top = minHeight + "px";
                    items[i].style.left = colIndex * itemW + "px";

                    colHeightArr[colIndex] += items[i].offsetHeight;
                }
            }
        }
    }

    function getMoreData() {
        var ret = {
            data: [{
                picName: "1.png"                
            }, {
                picName: "2.png"
            }, {
                picName: "3.png"
            }, {
                picName: "4.png"
            }, {
                picName: "5.png"
            }]
        };

        return ret.data;
    }

    window.onload = function() {
        loadWaterfall("main", "box");
        window.onscroll = function() {
            var items = getByClass("box", "main");
            var pageH = document.documentElement.clientHeight || document.body.clientHeight;
            var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
            if (items[items.length-1].offsetTop + Math.floor(items[items.length-1].offsetHeight / 2) < pageH + scrollY) {
                var data = getMoreData();
                for (var i = 0; i < data.length; i++) {
                    var parentObj = document.getElementById("main");
                    var newBox = document.createElement("div");
                    newBox.className = "box";
                    parentObj.appendChild(newBox);
                    var boxContent = document.createElement("div");
                    boxContent.className = "pic";
                    newBox.appendChild(boxContent);
                    var imgObj = document.createElement("img");
                    imgObj.src = "images/" + data[i].picName;
                    boxContent.appendChild(imgObj);
                }
                loadWaterfall("main", "box");
            }
        }
    };
    </script>
</body>
</html>