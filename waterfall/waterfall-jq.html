<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>waterfall-js</title>
    <style>
    html, body, div, img {
        margin: 0;
        padding: 0;
    }

    #main {
        position: relative;
    }

    #main .box {
        padding: 10px;
        float: left;
    }

    #main .box .pic {
        width: 200px;
        padding: 10px;
        border: 1px solid #ccc;
        box-shadow: 0 0 5px #ccc;
        border-radius: 5px;
    }

    #main .box .pic img {
        width: 100%;
        height: auto;
    }
    </style>
</head>
<body>
    <div id="main">
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/4.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/1.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/5.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/3.png" alt="waterfall-png">    
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/2.png" alt="waterfall-png">    
            </div>
        </div>
    </div>

    <script src="http://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>
    <script>
    function getMoreData() {
        var ret = {
            data: [{
                picName: "1.png"                
            }, {
                picName: "2.png"
            }, {
                picName: "3.png"
            }, {
                picName: "4.png"
            }, {
                picName: "5.png"
            }]
        };

        return ret.data;
    }

    function loadWaterfall() {
        var $boxItems = $("#main .box");
        var boxW = $boxItems.eq(0).outerWidth();
        var colNum = Math.floor($(window).width() / boxW);
        $("#main").width(boxW * colNum).css("margin", "0 auto");

        var colHeightArr = [];
        $boxItems.each(function(index, boxItem) {
            var $boxItem = $(boxItem);
            var boxH = $boxItem.outerHeight();
            if (index < colNum) {
                colHeightArr.push(boxH);
            } else {
                var minHeight = Math.min.apply(null, colHeightArr);
                var minHeightIndex = $.inArray(minHeight, colHeightArr);
                $boxItem.css({
                    'position': 'absolute',
                    'top': minHeight + 'px',
                    'left': boxW * minHeightIndex
                });
                colHeightArr[minHeightIndex] += boxH;
            }
        });
    }

    function checkNeedLoad() {
        var $lastBox = $("#main .box").last();
        var lastBoxOffsetTop = $lastBox.offset().top + Math.floor($lastBox.outerHeight() / 2);
        var scrollTop = $(window).scrollTop();
        var pageH = $(window).height();
        return lastBoxOffsetTop < pageH + scrollTop;
    }

    $(window).on("load", function() {
        loadWaterfall();
        $(window).on("scroll", function() {
            if (checkNeedLoad()) {
                $.each(getMoreData(), function(index, item) {
                    var $box = $("<div>").addClass("box").appendTo($("#main"));
                    var $pic = $("<div>").addClass("pic").appendTo($box);
                    $("<img>").attr("src", "images/" + item.picName).appendTo($pic);
                });
                loadWaterfall();
            }
        });
    });
    </script>
</body>
</html>